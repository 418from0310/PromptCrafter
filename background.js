// ğŸ”´ DeepSeek API é…ç½® (ä¿æŒä½ çš„ Key)
const API_KEY = 'åœ¨è¿™é‡Œå¡«å…¥ä½ çš„DeepSeek_API_Key'; 
const API_URL = 'https://api.deepseek.com/chat/completions';

chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
    if (request.action === "optimize_prompt") {
        console.log("ğŸš€ æ”¶åˆ°è¯·æ±‚ï¼Œæ­£åœ¨è¿›è¡Œ[é€»è¾‘ç»†åŒ–ä¸éœ€æ±‚é‡æ„]...");

        // =================================================================
        // æ ¸å¿ƒä¿®æ”¹ï¼šé’ˆå¯¹ä½ æå‡ºçš„ä¸‰ä¸ªç—›ç‚¹å®šåˆ¶çš„ System Prompt
        // =================================================================
        const systemPrompt = `ä½ æ˜¯ä¸€ä½æ‹¥æœ‰10å¹´ç»éªŒçš„â€œé«˜çº§éœ€æ±‚åˆ†æå¸ˆâ€å’Œâ€œæç¤ºè¯ä¼˜åŒ–ä¸“å®¶â€ã€‚
ç”¨æˆ·çš„åŸå§‹æç¤ºè¯é€šå¸¸å­˜åœ¨ä»¥ä¸‹ä¸‰ä¸ªé—®é¢˜ï¼Œä½ çš„ä»»åŠ¡æ˜¯é’ˆå¯¹æ€§åœ°ä¿®å¤å®ƒä»¬ï¼š
1. **è¡¨è¾¾æ¨¡ç³Š**ï¼šè¯­æ³•ä¸é€šæˆ–æ„å›¾ä¸æ¸…ã€‚ -> **ä½ éœ€è¦ä¿®æ­£è¯­ç—…ï¼Œä½¿è¡¨è¾¾å‡†ç¡®ã€‚**
2. **ç¼ºä¹ç»†èŠ‚**ï¼šè¦æ±‚å¤ªç¬¼ç»Ÿï¼Œæ²¡æœ‰åˆ†ç‚¹åˆ—å‡ºã€‚ -> **ä½ éœ€è¦å°†éœ€æ±‚æ‹†è§£ä¸ºæ¸…æ™°çš„ Bullet Points (åˆ†ç‚¹åˆ—è¡¨)ã€‚**
3. **è¿‡äºå®è§‚**ï¼šç¼ºå°‘å…·ä½“çš„æ‰§è¡Œæ ‡å‡†ã€‚ -> **ä½ éœ€è¦è¡¥å……å…·ä½“çš„èƒŒæ™¯ã€çº¦æŸæ¡ä»¶ã€æŠ€æœ¯æ ˆæˆ–è¯­æ°”è¦æ±‚ã€‚**

---
**å¤„ç†è§„åˆ™**ï¼š
1. **å¼€å¤´**ï¼šç”¨ä¸€å¥è¯ç®€ç»ƒåœ°é‡è¿°ç”¨æˆ·çš„æ ¸å¿ƒéœ€æ±‚ï¼ˆ[ä¼˜åŒ–åæŒ‡ä»¤]ï¼‰ã€‚
2. **ä¸­é—´**ï¼šä½¿ç”¨å±‚çº§åˆ†æ˜çš„åˆ—è¡¨ï¼ˆ1. 2. 3. æˆ– - ï¼‰ï¼Œè¯¦ç»†åˆ—å‡ºå…·ä½“çš„æ‰§è¡Œè¦æ±‚ã€åŠŸèƒ½ç‚¹æˆ–å†…å®¹å¤§çº²ã€‚
3. **ç»“å°¾**ï¼šè¡¥å……å¯¹è¾“å‡ºç»“æœçš„æ ¼å¼è¦æ±‚ï¼ˆå¦‚ï¼šä»£ç é£æ ¼ã€å­—æ•°é™åˆ¶ã€è¯­è¨€é£æ ¼ï¼‰ã€‚
4. **è¯­æ°”**ï¼šä¿æŒä¸“ä¸šã€å®¢è§‚ã€å…·æœ‰æŒ‡å¯¼æ€§ã€‚ä¸è¦æ”¹å˜ç”¨æˆ·çš„åŸæ„ï¼Œè€Œæ˜¯å°†å…¶â€œå…·è±¡åŒ–â€ã€‚

**ç¤ºä¾‹**ï¼š
ç”¨æˆ·è¾“å…¥ï¼š"å¸®æˆ‘å†™ä¸ªè´ªåƒè›‡"
ä½ çš„è¾“å‡ºï¼š
"è¯·ä½¿ç”¨ Python çš„ Pygame åº“ç¼–å†™ä¸€ä¸ªå®Œæ•´çš„è´ªåƒè›‡æ¸¸æˆã€‚
å…·ä½“éœ€æ±‚å¦‚ä¸‹ï¼š
1. **ç•Œé¢è®¾è®¡**ï¼šèƒŒæ™¯ä¸ºé»‘è‰²ï¼Œè›‡èº«ä¸ºç»¿è‰²æ–¹å—ï¼Œé£Ÿç‰©ä¸ºçº¢è‰²åœ†ç‚¹ã€‚
2. **äº¤äº’é€»è¾‘**ï¼šä½¿ç”¨æ–¹å‘é”®æ§åˆ¶ç§»åŠ¨ï¼Œè›‡å¤´æ’å¢™æˆ–æ’å‡»è‡ªèº«åˆ™æ¸¸æˆç»“æŸã€‚
3. **åŠŸèƒ½æ¨¡å—**ï¼š
   - åŒ…å«å¼€å§‹ç•Œé¢å’Œç»“æŸè®¡åˆ†æ¿ã€‚
   - å®æ—¶æ˜¾ç¤ºå½“å‰å¾—åˆ†ã€‚
   - éšç€åˆ†æ•°å¢åŠ ï¼Œè›‡çš„ç§»åŠ¨é€Ÿåº¦é€æ¸åŠ å¿«ã€‚
è¯·ç¡®ä¿ä»£ç æ³¨é‡Šæ¸…æ™°ï¼Œç¬¦åˆ PEP8 è§„èŒƒã€‚"
=================================================================`;

        const messages = [
            { role: "system", content: systemPrompt },
            { role: "user", content: `ç”¨æˆ·åŸå§‹è¾“å…¥: "${request.text}"` }
        ];

        fetch(API_URL, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${API_KEY}`
            },
            body: JSON.stringify({
                model: "deepseek-chat",
                messages: messages,
                stream: false,
                temperature: 0.7 // ä¿æŒä¸€å®šçš„çµæ´»æ€§ï¼Œè®©å®ƒèƒ½è¡¥å……ç»†èŠ‚
            })
        })
        .then(async response => {
            const data = await response.json();
            if (!response.ok) {
                console.error("API æŠ¥é”™:", data);
                sendResponse({ result: `âŒ ä¼˜åŒ–å¤±è´¥: ${data.error?.message || 'æœªçŸ¥é”™è¯¯'}` });
                return;
            }
            
            if (data.choices && data.choices.length > 0) {
                const optimizedText = data.choices[0].message.content;
                sendResponse({ result: optimizedText });
            } else {
                sendResponse({ result: "âŒ AI è¿”å›ç©ºå†…å®¹" });
            }
        })
        .catch(error => {
            console.error("ç½‘ç»œé”™è¯¯:", error);
            sendResponse({ result: "âŒ ç½‘ç»œè¿æ¥å¤±è´¥" });
        });

        return true; 
    }
});